import configparser
from lib.cve_feeds import cve_monitor
from lib.exp_label import exp_init,exp_add,exp_all,exp_query
from lib.exp_predict import exp_model
from lib.visualization import draw_report

def auto_run():
    conf=configparser.ConfigParser()
    conf.read('conf/info.conf')
    monitor_init=conf.get('CVE_Feeds','init')
    label_init=conf.get('CVE_Label','init')
    # parsed and inserted CVE data of nvd.nist.gov
    ret,cve_day,first_part_exp_add=cve_monitor(monitor_init)
    if monitor_init=='True':
        all_exp=exp_all()
    # parsed and inserted third part exp data
    if label_init=='True':
        exp_init()
    else:
        exp_add()
    day_exp_add,month_exp_add=exp_query()
    # trained exp prediction model
    day_exp_proba,month_exp_proba=exp_model(delta=-1)
    # output report.md
    draw_report(day_exp_add,day_exp_proba,month_exp_add,month_exp_proba)

def auto_push():
    ts = "cve-flow_bot_pushed_at_"+time_delta(format="%Y-%m-%d-%H:%m:%S")
    cmd = "git add . && git commit -m '%s' && git push origin master" % (ts)

    ret = os.system(cmd)
    if ret != 0:
        print("%s failed" % cmd)

if __name__=="__main__":
    auto_run()
    auto_push()
    