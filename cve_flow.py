import os
import configparser
import smtplib
import mistune
from email.mime.text import MIMEText
from lib.utils import time_delta
from lib.cve_feeds import cve_monitor
from lib.exp_label import exp_init,exp_add,exp_all,exp_query
from lib.exp_predict import exp_model
from lib.visualization import draw_report,draw_introduction

def auto_run():
    conf=configparser.ConfigParser()
    conf.read('conf/info.conf')
    monitor_init=conf.get('CVE_Feeds','init')
    label_init=conf.get('CVE_Label','init')
    # parsed and inserted CVE data of nvd.nist.gov
    ret,cve_day,first_part_exp_add=cve_monitor(monitor_init)
    print(cve_day)
    # if monitor_init=='True':
    #     all_exp=exp_all()
    # parsed and inserted third part exp data
    if label_init=='True':
        exp_init()
    else:
        exp_add()
    day_exp_add,month_exp_add=exp_query(delta=[0,-1])
    # trained exp prediction model
    epoch_exp_proba,day_exp_proba,month_exp_proba=exp_model(delta=[0,-1],epoch=cve_day)
    # output report.md
    draw_report(day_exp_add,day_exp_proba,month_exp_add,month_exp_proba)

    return epoch_exp_proba,day_exp_add,day_exp_proba

def auto_push():
    ts = "cve-flow_bot_pushed_at_"+time_delta(format="%Y-%m-%d-%H:%m:%S")
    cmd = "git add . && git commit -m '%s' && git push origin master" % (ts)

    ret = os.system(cmd)
    if ret != 0:
        print("%s failed" % cmd)
    return ret

def email_intro(day_exp_proba):
    md1,md2=draw_introduction(day_exp_proba=day_exp_proba)
    title='#### EXP Prediction Yesterday->Today'
    md=os.linesep.join(md2)
    md=title+os.linesep+md

    return md

def auto_email(content,msg_to='root@4o4notfound.org'):
    conf=configparser.ConfigParser()
    conf.read('conf/info.conf')
    msg_from=conf.get('Mail','sendmail')
    password=conf.get('Mail','password')

    subject = "CVE-Flow:CVE Threat Intelligence on {}".format(time_delta(format='%Y-%m-%d'))
    content = mistune.markdown(content, escape=True, hard_wrap=True)
    link = "More informations:https://github.com/404notf0und/CVE-Flow/blob/master/README.md" 
    content=content+link
    msg = MIMEText(content, 'html', 'utf-8')
     
    msg['Subject'] = subject
    msg['From'] = msg_from
    msg['To'] = msg_to
     
    try:
        client = smtplib.SMTP_SSL('smtp.163.com', smtplib.SMTP_SSL_PORT)
        print("[+] Connect to mail server")
     
        client.login(msg_from, password)
        print("[+] Successfully log in")
     
        client.sendmail(msg_from, msg_to, msg.as_string())
        print("[+] Successfully send mail")
    except smtplib.SMTPException as e:
        print("[!] Send mail error")
    finally:
        client.quit()

if __name__=="__main__":
    epoch_exp_proba,day_exp_add,day_exp_proba=auto_run()
    ret=auto_push()
    md=email_intro(epoch_exp_proba)
    auto_email(content=md)
    