import configparser
from lib.cve_feeds import cve_monitor
from lib.exp_label import exp_init,exp_add,exp_all
from lib.exp_predict import exp_model
from lib.visualization import draw_report

def auto_run():
    conf=configparser.ConfigParser()
    conf.read('conf/info.conf')
    monitor_init=conf.get('CVE_Feeds','init')
    label_init=conf.get('CVE_Label','init')
    # CVE数据解析、入库
    ret,cve_day,first_part_exp_add=cve_monitor(monitor_init)
    first_part_exp_add=list(first_part_exp_add.values())
    if monitor_init=='True':
        all_exp=exp_all()
    # 第三方EXP数据解析、入库
    if label_init=='True':
        exp_init()
    else:
        third_part_exp_add=exp_add()
        day_exp_add=first_part_exp_add+third_part_exp_add
    day_exp_add=[('CVE-2019-0235', 'Apache OFBiz 17.12.01 is vulnerable to some CSRF attacks.', '2020-04-30T20:15Z', '2020-07-05T10:15Z', 'https://nvd.nist.gov/vuln/detail/CVE-2019-0235'), ('CVE-2020-7067', 'In PHP versions 7.2.x below 7.2.30, 7.3.x below 7.3.17 and 7.4.x below 7.4.5, if PHP is compiled with EBCDIC support (uncommon), urldecode() function can be made to access locations past the allocated memory, due to erroneously using signed numbers as array indexes.', '2020-04-27T21:15Z', '2020-07-05T20:15Z', 'https://nvd.nist.gov/vuln/detail/CVE-2020-7067'), ('CVE-2020-5902', 'In BIG-IP versions 15.0.0-15.1.0.3, 14.1.0-14.1.2.5, 13.1.0-13.1.3.3, 12.1.0-12.1.5.1, and 11.6.1-11.6.5.1, the Traffic Management User Interface (TMUI), also referred to as the Configuration utility, has a Remote Code Execution (RCE) vulnerability in undisclosed pages.', '2020-07-01T15:15Z', '20200706', 'https://github.com/yasserjanah/CVE-2020-5902'), ('CVE-2014-0160', 'The (1) TLS and (2) DTLS implementations in OpenSSL 1.0.1 before 1.0.1g do not properly handle Heartbeat Extension packets, which allows remote attackers to obtain sensitive information from process memory via crafted packets that trigger a buffer over-read, as demonstrated by reading private keys, related to d1_both.c and t1_lib.c, aka the Heartbleed bug.;CVSS V2 scoring evaluates the impact of the vulnerability on the host where the vulnerability is located. When evaluating the impact of this vulnerability to your organization, take into account the nature of the data that is being protected and act according to your organization’s risk acceptance. While CVE-2014-0160 does not allow unrestricted access to memory on the targeted host, a successful exploit does leak information from memory locations which have the potential to contain particularly sensitive information, e.g., cryptographic keys and passwords.  Theft of this information could enable other attacks on the information system, the impact of which would depend on the sensitivity of the data and functions of that system.', '2014-04-07T22:55Z', '20200706', 'https://github.com/rouze-d/heartbleed')]
    print(day_exp_add)
    # 训练模型:过去
    exp_proba,exp_proba2=exp_model(delta=-1)
    print(exp_proba,exp_proba2)
    # 输出报告：过去/现在/未来
    draw_report(day_exp_add,exp_proba,exp_proba2)
    print('[+] Done!')

if __name__=="__main__":
    auto_run()

    